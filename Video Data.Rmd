---
title: "Video Data"
output: html_document
---

Prep libraries and import datasheets
```{r}
library(tidyverse)

video_events <- read_csv("video Notable Events.csv")
video_morts <- read_csv("Mort Counts for Vid Analysis.csv")
no_event_vids <- read_csv("No Event Videos.csv")
video_times <- read_csv("Video Start and Stop Times.csv")
```


Joining event data sheet with start/stop time sheet and manipulating to create a variable column for real event dates and times
```{r}
#Test events (lights off known time 20:00) show all notable event times coming out within 1.5 seconds of each other accross cameras and within 1.5 seconds of the correct time (20:00). This should be more than sufficient for the timescales I'm working on. 

realtime_events <- video_events %>%
   left_join(video_times, by = "video_code")

realtime_events <- realtime_events %>%
  mutate(
     start_datetime = as.POSIXct(paste(date.x, start), format = "%d-%b-%y %H:%M:%S")) %>%
   separate(timestamp, into = c("hh", "mm", "ss"), sep = ":", convert = TRUE) %>%
  mutate(
    timestamp_seconds = hh * 60 + mm, #what timestamp recognizes as hour is actually minute, minute is second
    real_timestamp_secs  = timestamp_seconds * 29.97,,
    real_timestamp_hms  = seconds_to_period(real_timestamp_secs),
    event_true_datetime = start_datetime + real_timestamp_hms
  )

```


### Bar Graphs ###
```{r}
#create bar chart showing notable events sans test times and feeds accross all cams
video_events %>%
  group_by(event_type, camera) %>%
  filter(event_type != "Test") %>%
  filter(event_type != "Feed") %>%
  summarize(count = n()) %>%
  ggplot(aes(x = event_type, y = count, fill = factor(camera))) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Notable Events by Camera",
       x = "Event",
       y = "Count") +
  theme_minimal()

```

```{r}

#create bar chart showing notable events sans test by time of day
video_events %>%
group_by(event_type, time_of_day) %>%
  filter(event_type != "Test") %>%
  filter(event_type != "Feed") %>%
  summarize(count = n()) %>%
  ggplot(aes(x = event_type, y = count, fill = time_of_day)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Notable Events by Camera",
       x = "Event",
       y = "Count") +
  theme_minimal()


```

```{r}

#create bar chart total cannibalism morts by moult stage
video_events %>%
group_by(event_type, mort_moult_stage, time_of_day) %>%
  filter(mort_moult_stage != "NA") %>%
  filter(mort_cause == "Cannibalism") %>%
  summarize(count = n()) %>%
  ggplot(aes(x = mort_moult_stage, y = count, fill = time_of_day)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Cannibalism Events by Moult Stage",
       x = "Event",
       y = "Count") +
  theme_minimal()


```
Having the one 'moulting' bar is really ugly and hard to interpret, maybe should go back and re-watch, classify as either pre, post or unkown. I remeber that vid and it is weird


```{r}
# Moults over the full experiment
moult_tally <- video_events %>%
  filter(event_type == "Moult") %>%   
  group_by(day_number, camera, time_of_day) %>%
  summarise(count = n(), .groups = "drop")

ggplot(moult_tally, aes(x = day_number, y = count)) +
  geom_col(position = "dodge") +
  labs(
    title = "Moults by Day",
    x = "Day",
    y = "Moults",
    color = "Camera Number"
  ) +
  theme_minimal()
```

Fucking about with boxplots
```{r}

moult_count <- video_events %>%
  filter(event_type == "Moult") %>%
  group_by(camera, time_of_day) %>%
  summarize(count = n(), .groups = "drop")

ggplot(moult_count, aes(x = time_of_day , y = count, )) +
  geom_boxplot()

```

Moult/Mort visualization bt tank 
```{r}
realtime_events %>%
filter(event_type != "Test") %>%
  filter(event_type != "Feed") %>%
ggplot() +
  geom_point(aes(x = event_true_datetime, y = factor(camera.x), color = event_type), size = 3) +
  labs(x = "Time", y = "Tank", color = "Event Type") +
  theme_minimal()
```
Summary table event counts
```{r}
events_summary <- realtime_events %>%
  mutate(event_true_date = as.Date(event_true_datetime)) %>% # this is important because in the original date column the date is the day the video started not the actual date (ie things that happen after midnight are not technically the correct date in the original)
  group_by(camera.x, event_true_date, event_type) %>%
  summarise(count = n(), .groups = "drop")
```

Event count per day per tank bar graph
```{r}
events_summary %>%
  filter(event_type != "Test") %>%
  filter(event_type != "Feed") %>%

ggplot(aes(x = event_true_date, y = count, fill = event_type)) +
  geom_col(position = "dodge") +
  facet_wrap(~camera.x) +
  labs(x = "Date", y = "Count per day", fill = "Event Type") +
  theme_minimal()
```

Testing autocorrolation chattage, it seems to not fully work. That's for later.
```{r}
bin_size <- 10*60  # 10 minutes in seconds

events_binned <- realtime_events %>%
  group_by(camera.x, event_type) %>%
  mutate(
    # seconds since start of experiment per tank
    time_sec = as.numeric(event_true_datetime - min(event_true_datetime)),
    # assign bin
    bin = floor(time_sec / bin_size)
  ) %>%
  ungroup() %>%
  group_by(camera.x, event_type, bin) %>%
  summarise(count = n(), .groups = "drop")

all_bins <- expand.grid(
  camera.x = unique(events_binned$camera.x),
  event_type = unique(events_binned$event_type),
  bin = 0:max(events_binned$bin)
)

events_binned <- events_binned %>%
  group_by(camera.x, event_type, bin) %>%
  summarise(count = n(), .groups = "drop") %>%
  right_join(all_bins, by = c("camera.x", "event_type", "bin")) %>%
  mutate(count = ifelse(is.na(count), 0, count)) %>%
  arrange(camera.x, event_type, bin)

autocorr_results <- events_binned %>%
  group_by(camera.x, event_type) %>%
  summarise(
    acf_values = list(acf(count, plot = FALSE)$acf),
    lags = list(acf(count, plot = FALSE)$lag),
    .groups = "drop"
  )

cam_example <- 1
event_example <- "Feed"
acf_data <- events_binned %>% filter(camera.x == cam_example, event_type == event_example)

acf(acf_data$count, main = paste("ACF - Tank", cam_example, "-", event_example))
```