---
title: "Video Data"
output: html_document
---

Prep libraries and import datasheets
```{r}

library(tidyverse)

video_events <- read_csv("video Notable Events.csv")
video_morts <- read_csv("Mort Counts for Vid Analysis.csv")
no_event_vids <- read_csv("No Event Videos.csv")
video_times <- read_csv("Video Start and Stop Times.csv")
isolated_counts <-read.csv("Isolated_Counts.csv")
halfday_morts <-read.csv("Morts by half day.csv")
```


Joining event data sheet with start/stop time sheet and manipulating to create a variable column for real event dates and times
```{r}
#Test events (lights off known time 20:00) show all notable event times coming out within 1.5 seconds of each other accross cameras and within 1.5 seconds of the correct time (20:00). This should be more than sufficient for the timescales I'm working on. 

realtime_events <- video_events %>%
   left_join(video_times, by = "video_code")

realtime_events <- realtime_events %>%
  mutate(
     start_datetime = as.POSIXct(paste(date.x, start), format = "%d-%b-%y %H:%M:%S")) %>%
   separate(timestamp, into = c("hh", "mm", "ss"), sep = ":", convert = TRUE) %>%
  mutate(
    timestamp_seconds = hh * 60 + mm, #what timestamp recognizes as hour is actually minute, minute is second
    real_timestamp_secs  = timestamp_seconds * 29.97,,
    real_timestamp_hms  = seconds_to_period(real_timestamp_secs),
    event_true_datetime = start_datetime + real_timestamp_hms
  )

```

Making appropriate data frame for survival curve
```{r}
halfday_morts_long <-halfday_morts %>%
  pivot_longer(
    cols = starts_with("Morts"),
    names_to = "Tank",
    values_to = "Morts"
  )

expanded_morts <- halfday_morts_long %>%
  filter(Morts > 0) %>%
  uncount(weights = Morts, .id = "death_num") %>%
  mutate(
    status = 1  # died
  )

start_counts <- data.frame(
  Tank = c("Morts.I", "Morts.1", "Morts.2", "Morts.3", "Morts.4"),
  start_n = c(44, 11, 11, 11, 11),
  treatment = c("individual", "group", "group", "group", "group")
)

total_morts <- expanded_morts %>%
  count(Tank, name = "Morts")

survivors <- start_counts %>%
  left_join(total_morts, by = "Tank") %>%
  mutate(
    Morts = replace_na(Morts, 0),
    survivors = start_n - Morts
  ) %>%
  filter(survivors > 0) %>%
  uncount(weights = survivors, .id = "survivor_num") %>%
  mutate(
    Day = 30,
    status = 0
  )

survival_data <- bind_rows(
  expanded_morts %>% select(Tank, Day, status),
  survivors %>% select(Tank, Day, status)
) %>%
  left_join(start_counts %>% select(Tank, treatment), by = "Tank") %>%
  mutate(ID = row_number())

survival_for_curve <- survival_data %>%
  group_by(Tank) %>%
  mutate(
    # assign a unique ID *within each tank*
    ID = paste0(Tank, "_", row_number())
  ) %>%
  ungroup()

```

Trying a survival curve
```{r}

surv_obj <- Surv(time = survival_for_curve$Day, event = survival_for_curve$status)

library(coxme)

# (A) Cox mixed-effects model with tank random intercept (frailty) using coxme
# This treats each group tank as a clustering level; for individual animals their 'tank' is unique
fit_coxme <- coxme(surv_obj ~ treatment + (1 | Tank), data = survival_for_curve)
print(summary(fit_coxme))

# (B) Alternative: Cox proportional hazards with cluster-robust SE (no random effect estimate)
fit_coxph_cluster <- coxph(surv_obj ~ treatment + cluster(Tank), data = survival_for_curve)
summary(fit_coxph_cluster)

# 9) PH assumption check for Cox model (note: coxme has limitations here)
# ---------------------------
# For the coxph(cluster) model:
zph <- cox.zph(fit_coxph_cluster)
print(zph)
plot(zph)  # visual check: lines close to horizontal indicate PH reasonable
#Not so, it seems proportional hazard of death between individual and group may change over time, makes sense, few individual deaths toward end

#Kaplan Myer
km_fit <- survfit(surv_obj ~ treatment, data = survival_for_curve)

survdiff(surv_obj ~ treatment, data = survival_for_curve)

# Base R plot
plot(km_fit, xlab = "Time (days)", ylab = "Survival probability",
     main = "Kaplan-Meier survival by treatment", lwd = 2, lty = c(1, 2))
legend("bottomleft", legend = names(km_fit$strata), lty = 1:length(km_fit$strata))

```


### Bar Graphs ###
```{r}
#create bar chart showing notable events sans test times and feeds accross all cams
video_events %>%
  group_by(event_type, camera) %>%
  filter(event_type != "Test") %>%
  filter(event_type != "Feed") %>%
  summarize(count = n()) %>%
  ggplot(aes(x = event_type, y = count, fill = factor(camera))) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Notable Events by Camera",
       x = "Event",
       y = "Count") +
  theme_minimal()

```

```{r}

#create bar chart showing notable events sans test by time of day
video_events %>%
group_by(event_type, time_of_day) %>%
  filter(event_type != "Test") %>%
  filter(event_type != "Feed") %>%
  summarize(count = n()) %>%
  ggplot(aes(x = event_type, y = count, fill = time_of_day)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Notable Events by Camera",
       x = "Event",
       y = "Count") +
  theme_minimal()


```

```{r}

#create bar chart total cannibalism morts by moult stage
video_events %>%
group_by(event_type, mort_moult_stage, time_of_day) %>%
  filter(mort_moult_stage != "NA") %>%
  filter(mort_cause == "Cannibalism") %>%
  summarize(count = n()) %>%
  ggplot(aes(x = mort_moult_stage, y = count, fill = time_of_day)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Cannibalism Events by Moult Stage",
       x = "Event",
       y = "Count") +
  theme_minimal()


```
Having the one 'moulting' bar is really ugly and hard to interpret, maybe should go back and re-watch, classify as either pre, post or unkown. I remeber that vid and it is weird, but the animal DOES appear to be cannibalized immediatedly as it beigns to moult, not after


```{r}
# Moults over the full experiment
moult_tally <- video_events %>%
  filter(event_type == "Moult") %>%   
  group_by(day_number, camera, time_of_day) %>%
  summarise(count = n(), .groups = "drop")

ggplot(moult_tally, aes(x = day_number, y = count)) +
  geom_col(position = "dodge") +
  labs(
    title = "Moults by Day",
    x = "Day",
    y = "Moults",
    color = "Camera Number"
  ) +
  theme_minimal()
```

Moult/Mort visualization bt tank 
```{r}
realtime_events %>%
filter(event_type != "Test") %>%
  filter(event_type != "Feed") %>%
ggplot() +
  geom_point(aes(x = event_true_datetime, y = factor(camera.x), color = event_type), size = 3) +
  labs(x = "Time", y = "Tank", color = "Event Type") +
  theme_minimal()
```
Summary table event counts
```{r}
events_summary <- realtime_events %>%
  mutate(event_true_date = as.Date(event_true_datetime)) %>% # this is important because in the original date column the date is the day the video started not the actual date (ie things that happen after midnight are not technically the correct date in the original)
  group_by(camera.x, event_true_date, event_type) %>%
  summarise(count = n(), .groups = "drop")
```

Event count per day per tank bar graph
```{r}
events_summary %>%
  filter(event_type != "Test") %>%
  filter(event_type != "Feed") %>%

ggplot(aes(x = event_true_date, y = count, fill = event_type)) +
  geom_col(position = "dodge") +
  facet_wrap(~camera.x) +
  labs(x = "Date", y = "Count per day", fill = "Event Type") +
  theme_minimal()
```



